const sendMsg2Content=({msg:e,payload:t})=>{chrome.tabs.query({active:!0,currentWindow:!0},(a=>{/^http/.test(a[0]?.url)&&("object"==typeof t&&(t=JSON.stringify(t)),void 0===t&&(t=""),chrome.tabs.sendMessage(a[0].id,{msg:e,payload:t},(()=>chrome.runtime.lastError)))}))},DEFAULT_CONFIG={zIndex:1e4,width:0,offsetX:0,offsetY:0,enableDomRulers:!1,enableTextReplace:!1},setConfig=e=>{e.zIndex=+e.zIndex||DEFAULT_CONFIG.zIndex,e.width=+e.width||DEFAULT_CONFIG.width,e.offsetX=+e.offsetX||DEFAULT_CONFIG.offsetX,e.offsetY=+e.offsetY||DEFAULT_CONFIG.offsetY,e.enableDomRulers=!!e.enableDomRulers,e.enableTextReplace=!!e.enableTextReplace,zIndex.value=e.zIndex,width.value=e.width,offsetX.value=e.offsetX,offsetY.value=e.offsetY,enableDomRulers.checked=e.enableDomRulers,enableTextReplace.checked=e.enableTextReplace,chrome.storage.local.set({sketchMeasureCompareConfig:e})},getConfig=e=>e?Promise.resolve(JSON.parse(e)):new Promise((e=>{chrome.storage.local.get(["sketchMeasureCompareConfig"],(t=>{e(t.sketchMeasureCompareConfig||DEFAULT_CONFIG)}))}));sendMsg2Content({msg:"getConfig"}),sendMsg2Content({msg:"getScreenInfo"});let screenInfo=null;chrome.runtime.onMessage.addListener((e=>{const{msg:t,payload:a}=e||{};var n;"getConfig"===t&&(n=a,n?Promise.resolve(JSON.parse(n)):new Promise((e=>{chrome.storage.local.get(["sketchMeasureCompareConfig"],(t=>{e(t.sketchMeasureCompareConfig||DEFAULT_CONFIG)}))}))).then((e=>{setConfig(e),setTimeout((()=>{const e=document.createElement("style");e.innerHTML="\n                    .slider {\n                        transition: 0.1s;\n                    }\n                    .slider:before {\n                        transition: 0.1s;\n                    }\n                ",document.head.appendChild(e)}),100)})),"getScreenInfo"===t&&(diff.style.display="initial",screenInfo=JSON.parse(a))})),fetch(chrome.runtime.getURL("package.json")).then((e=>e.json())).then((e=>{version.innerHTML=`v${e.version}`})),apply.onclick=()=>{const e={zIndex:+zIndex.value||DEFAULT_CONFIG.zIndex,width:+width.value||DEFAULT_CONFIG.width,offsetY:+offsetY.value||DEFAULT_CONFIG.offsetY,offsetX:+offsetX.value||DEFAULT_CONFIG.offsetX,enableDomRulers:!!enableDomRulers.checked,enableTextReplace:!!enableTextReplace.checked};setConfig(e),sendMsg2Content({msg:"load",payload:chrome.runtime.getURL("index.min.js")}),sendMsg2Content({msg:"config",payload:e}),window.close()},diff.onclick=()=>{screenInfo&&!diff.disabled&&(diff.disabled=!0,chrome.tabs.captureVisibleTab({format:"png"},(e=>{const t=document.createElement("img");t.src=e,t.onload=()=>{const{win:e,ui:a,web:n,title:o}=screenInfo,s=t.width/e.width;Object.keys(e).forEach((t=>{e[t]=e[t]*s})),Object.keys(a).forEach((e=>{a[e]=a[e]*s})),Object.keys(n).forEach((e=>{n[e]=n[e]*s}));const i=document.createElement("canvas"),l=i.getContext("2d",{willReadFrequently:!0});i.width=3*a.width,i.height=a.height,l.drawImage(t,a.x,a.y,a.width,a.height,0,0,a.width,a.height),l.drawImage(t,n.x,n.y,n.width,n.height,a.width,0,n.width,n.height);const d=l.getImageData(0,0,a.width,a.height),f=l.getImageData(a.width,0,a.width,a.height),r=new ImageData(a.width,a.height);for(let e=0;e<r.data.length;e+=4){const t=Math.abs(d.data[e]-f.data[e]),a=Math.abs(d.data[e+1]-f.data[e+1]),n=Math.abs(d.data[e+2]-f.data[e+2]),o=128,s=t+a+n>256||t>o||a>o||n>o;r.data[e]=s?255:d.data[e],r.data[e+1]=s?0:d.data[e+1],r.data[e+2]=s?255:d.data[e+2],r.data[e+3]=255}l.putImageData(r,2*a.width,0),l.fillStyle="#fff",l.fillRect(0,0,50,30),l.fillRect(a.width,0,70,30),l.fillRect(2*a.width,0,70,30),l.fillStyle="#f00",l.font="20px Arial",l.fillText("UI",10,22),l.fillText("WEB",10+a.width,22),l.fillText("DIFF",10+2*a.width,22);const c=document.createElement("a");c.href=i.toDataURL(),c.download=`${o||"page"}-diff.png`,c.click()}})))};